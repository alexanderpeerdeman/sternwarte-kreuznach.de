<!DOCTYPE html>
<html>

<head>
    <title>Sternwarte Search Test </title>
</head>

<body>
    <p>
        Search:
        <input id="search" type="text">
    </p>
    <p>
        Results:
        <div id="results">
        </div>
    </p>
    <script src="https://unpkg.com/lunr/lunr.js"></script>
    <script src="https://unpkg.com/lunr-languages/lunr.stemmer.support.js"></script>
    <script src="https://unpkg.com/lunr-languages/lunr.de.js"></script>
    <script type="text/javascript">
        let lunr_index;
        let pages_index;

        function initLunr() {

            fetch("search.json")
                .then(res => res.json())
                .then((documents) => {
                    pages_index = documents;
                    lunr_index = lunr(function () {
                        this.ref("href");
                        this.field("title", { boost: 5 });
                        this.field("content");

                        documents.forEach(function (doc) {
                            this.add(doc);
                        }, this)
                    })
                })
                .catch(err => { throw err });
        }

        function initUI() {
            const results = document.getElementById('results');
            const search = document.getElementById('search');
            search.addEventListener("keyup", function (event) {
                results.innerHTML = "";

                let query = event.target.value;

                if (query.length < 2) {
                    return
                }
                let lunr_results = perform_search(query);

                renderResults(lunr_results);
            })
        }

        function perform_search(query) {
            query = "*"+query+"* "+query+"~1";
            search_results = lunr_index.search(query);

            return search_results.map(function (result) {
                return pages_index.filter(function (page) {
                    return page.href === result.ref;
                })[0];
            })
        };


        function renderResults(results) {
            if (results.length < 1) {
                return;
            }

            const results_item = document.getElementById('results');

            results.slice(0, 15).forEach(function (result) {
                results_item.innerHTML += ("<a href='" + result.href + "'><p>" + result.title + "</p></a>");
            })
        }

        initLunr();
        document.addEventListener("DOMContentLoaded", function (event) {
            initUI();
        });

    </script>
</body>

</html>